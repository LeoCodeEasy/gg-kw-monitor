<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Ads Monitor</title>
    
    <!-- 引入第三方库 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    
    <!-- 引入自定义样式文件 -->
    <link href="{{ url_for('static', filename='css/base.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/components.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/layout.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/utilities.css') }}" rel="stylesheet">
    
    <!-- 引入组件样式 -->
    <link href="{{ url_for('static', filename='css/components/search-box.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/components/image-preview.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/components/keywords.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/components/filter-bar.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/components/stats-bar.css') }}" rel="stylesheet">
</head>
<body>
    {% include 'components/keyword-manager.html' %}
    
    <div class="container-fluid">
        <!-- 引入筛选栏组件 -->
        {% include 'components/filter-bar.html' %}
        
        <!-- 结果显示区域 -->
        <div class="row" id="latestResults">
        </div>
        
        <!-- 引入图片预览组件 -->
        {% include 'components/image-preview.html' %}
    </div>
    
    <!-- 引入第三方库 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 引入工具类 -->
    <script src="{{ url_for('static', filename='js/utils/toast.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils/date-formatter.js') }}"></script>
    
    <!-- 引入数据处理模块 -->
    <script src="{{ url_for('static', filename='js/data/state.js') }}"></script>
    <script src="{{ url_for('static', filename='js/data/data-processor.js') }}"></script>
    
    <!-- 引入API客户端模块 -->
    <script src="{{ url_for('static', filename='js/api/api-client.js') }}"></script>
    
    <!-- 引入组件脚本 -->
    <script src="{{ url_for('static', filename='js/keywords/keyword-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/preview/image-preview.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ads/ad-display-manager.js') }}"></script>
    
    <script>
        let allResults = [];
        let currentKeywords = [];
        let currentPreviewIndex = -1;
        
        // 国家代码到全称的映射
        const countryNames = {
            'in': 'INDIA',
            'gh': 'GHANA',
            'sg': 'SINGAPORE',
            'us': 'USA',
            'uk': 'UK'
        };

        // 关键词编辑器相关函数
        let keywordsModal;
        
        function openKeywordsEditor() {
            if (!keywordsModal) {
                keywordsModal = new bootstrap.Modal(document.getElementById('keywordsModal'));
            }
            keywordsModal.show();
        }
        
        // 关键词管理相关变量
        let keywordsData = {};
        
        // 打开关键词编辑器
        async function openKeywordsEditor() {
            try {
                const response = await fetch('/api/keywords');
                const data = await response.json();
                if (data.error) {
                    showToast(data.error, 'error');
                    return;
                }
                keywordsData = data.keywords || {};
                updateCategorySelect();
                updateKeywordsList();
                new bootstrap.Modal(document.getElementById('keywordsModal')).show();
            } catch (error) {
                console.error('Error:', error);
                showToast('加载关键词失败: ' + error.message, 'error');
            }
        }

        // 更新分类选择框
        function updateCategorySelect() {
            const select = document.getElementById('categorySelect');
            select.innerHTML = '<option value="">选择分类...</option>';
            Object.keys(keywordsData).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }

        // 更新关键词列表
        function updateKeywordsList() {
            const container = document.querySelector('.keywords-list');
            container.innerHTML = '';
            
            Object.entries(keywordsData).forEach(([category, data]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-section mb-4';
                
                // 创建分类标题
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                categoryHeader.innerHTML = `
                    <div class="d-flex align-items-center">
                        <h6 class="mb-0">${category}</h6>
                        <div class="form-check ms-3">
                            <input class="form-check-input" type="checkbox" 
                                   ${data.enabled ? 'checked' : ''}
                                   onchange="toggleCategory('${category}')">
                            <label class="form-check-label">启用</label>
                        </div>
                    </div>
                    <div class="category-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="showAddKeyword('${category}')">
                            <i class="fa fa-plus"></i> 添加关键词
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${category}')">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                categoryDiv.appendChild(categoryHeader);
                
                // 添加关键词列表
                const keywordsList = document.createElement('div');
                keywordsList.className = 'keywords-list mt-2';
                data.keywords.forEach(keyword => {
                    const keywordItem = document.createElement('div');
                    keywordItem.className = 'keyword-item';
                    keywordItem.innerHTML = `
                        <span class="keyword-text">${keyword.text}</span>
                        <div class="keyword-actions">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       ${keyword.enabled ? 'checked' : ''}
                                       onchange="toggleKeyword('${category}', '${keyword.text}')">
                                <label class="form-check-label">启用</label>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteKeyword('${category}', '${keyword.text}')">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    `;
                    keywordsList.appendChild(keywordItem);
                });
                categoryDiv.appendChild(keywordsList);
                container.appendChild(categoryDiv);
            });
        }

        // 添加新分类
        async function addNewCategory() {
            const category = prompt('请输入新分类名称：');
            if (!category) return;
            
            if (keywordsData[category]) {
                showToast('分类已存在', 'error');
                return;
            }
            
            keywordsData[category] = {
                keywords: [],
                enabled: true
            };
            
            await saveKeywordsData();
            updateCategorySelect();
            updateKeywordsList();
        }

        // 删除分类
        async function deleteCategory(category) {
            if (!confirm(`确定要删除分类"${category}"吗？`)) return;
            
            delete keywordsData[category];
            await saveKeywordsData();
            updateCategorySelect();
            updateKeywordsList();
        }

        // 显示添加关键词表单
        function showAddKeyword(category) {
            const addForm = document.querySelector('.add-keyword-form');
            addForm.style.display = 'block';
            addForm.dataset.category = category;
            document.getElementById('newKeyword').focus();
        }

        // 添加新关键词
        async function addKeyword() {
            const category = document.querySelector('.add-keyword-form').dataset.category;
            const keyword = document.getElementById('newKeyword').value.trim();
            
            if (!keyword) {
                showToast('请输入关键词', 'error');
                return;
            }
            
            // 检查关键词是否已存在
            const exists = keywordsData[category].keywords.some(k => k.text === keyword);
            if (exists) {
                showToast('关键词已存在', 'error');
                return;
            }
            
            keywordsData[category].keywords.push({
                text: keyword,
                enabled: true
            });
            
            await saveKeywordsData();
            document.getElementById('newKeyword').value = '';
            document.querySelector('.add-keyword-form').style.display = 'none';
            updateKeywordsList();
        }

        // 删除关键词
        async function deleteKeyword(category, keyword) {
            if (!confirm(`确定要删除关键词"${keyword}"吗？`)) return;
            
            keywordsData[category].keywords = keywordsData[category].keywords
                .filter(k => k.text !== keyword);
            
            await saveKeywordsData();
            updateKeywordsList();
        }

        // 切换分类启用状态
        async function toggleCategory(category) {
            keywordsData[category].enabled = !keywordsData[category].enabled;
            await saveKeywordsData();
            updateKeywordsList();
        }

        // 切换关键词启用状态
        async function toggleKeyword(category, keyword) {
            const keywordObj = keywordsData[category].keywords
                .find(k => k.text === keyword);
            if (keywordObj) {
                keywordObj.enabled = !keywordObj.enabled;
                await saveKeywordsData();
                updateKeywordsList();
            }
        }

        // 保存关键词数据
        async function saveKeywordsData() {
            try {
                const response = await fetch('/api/keywords', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ keywords: keywordsData }),
                });
                
                const data = await response.json();
                if (data.error) {
                    showToast(data.error, 'error');
                    return false;
                }
                
                showToast(data.message || '保存成功', 'success');
                return true;
            } catch (error) {
                console.error('Error:', error);
                showToast('保存失败: ' + error.message, 'error');
                return false;
            }
        }

        // 修改保存关键词函数
        async function saveKeywords() {
            const keywords = document.getElementById('keywordsList').value
                .split('\n')
                .map(k => k.trim())
                .filter(k => k);

            try {
                const response = await fetch('/api/keywords', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ keywords: keywords }),
                });
                
                const data = await response.json();
                if (data.error) {
                    showToast(data.error, 'error');
                    return;
                }
                
                showToast(data.message || '关键词已保存', 'success');
                keywordsModal.hide();
                currentKeywords = keywords;
                document.getElementById('totalKeywords').textContent = keywords.length;
            } catch (error) {
                console.error('Error:', error);
                showToast('保存失败: ' + error.message, 'error');
            }
        }
        
        // 修改页面加载函数
        window.addEventListener('load', async () => {
            try {
                // 加载关键词
                const response = await fetch('/api/keywords');
                const data = await response.json();
                if (data.error) {
                    showToast(data.error, 'error');
                    return;
                }
                keywordsData = data.keywords || {};
                
                // 计算启用的关键词数量
                let enabledCount = 0;
                Object.values(keywordsData).forEach(category => {
                    if (category.enabled) {
                        category.keywords.forEach(keyword => {
                            if (keyword.enabled) {
                                enabledCount++;
                            }
                        });
                    }
                });
                document.getElementById('totalKeywords').textContent = enabledCount;
                
                // 加载最新结果
                const resultsResponse = await fetch('/latest');
                const results = await resultsResponse.json();
                
                // 更新广告数量
                document.getElementById('totalAds').textContent = results.length;
                
                // 更新最后更新时间
                const lastResult = results[0];
                if (lastResult && lastResult.timestamp) {
                    const date = new Date(lastResult.timestamp);
                    document.getElementById('lastUpdated').textContent = 
                        date.toLocaleString('zh-CN', { 
                            hour12: false,
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                }
                
                // 更新市场标签
                updateMarketTabs(results);
                
                // 显示结果
                displayResults(results);
            } catch (error) {
                console.error('Error:', error);
                showToast('加载数据失败: ' + error.message, 'error');
            }
        });

        // 修改开始爬取函数
        async function startCrawl() {
            try {
                const response = await fetch('/crawl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                if (data.error) {
                    showToast(data.error, 'error');
                    return;
                }
                
                showToast(data.message || '爬取完成');
                
                // 刷新页面显示最新结果
                const resultsResponse = await fetch('/latest');
                const results = await resultsResponse.json();
                
                // 更新广告数量
                document.getElementById('totalAds').textContent = results.length;
                
                // 更新最后更新时间
                if (results[0] && results[0].timestamp) {
                    const date = new Date(results[0].timestamp);
                    document.getElementById('lastUpdated').textContent = 
                        date.toLocaleString('zh-CN', { 
                            hour12: false,
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                }
                
                // 更新市场标签
                updateMarketTabs(results);
                
                // 显示结果
                displayResults(results);
            } catch (error) {
                console.error('Error:', error);
                showToast('爬取失败: ' + error.message, 'error');
            }
        }

        // 添加市场标签切换逻辑
        document.querySelectorAll('.market-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.market-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                if (tab.dataset.market === '') {
                    tab.classList.remove('active');
                }
                filterAndDisplayResults();
            });
        });

        // 修改筛选逻辑
        function filterAndDisplayResults(keepMarket = false) {
            const selectedMarket = document.querySelector('.market-tab.active')?.dataset.market || '';
            const searchText = document.getElementById('keywordFilter')?.value.toLowerCase().trim() || '';
            
            // 克隆原始数据
            let filteredResults = JSON.parse(JSON.stringify(allResults));
            
            // 对每个广告对象进行处理
            filteredResults = filteredResults.map(ad => {
                // 创建新的广告对象
                const newAd = {...ad};
                
                // 首先按市场筛选
                newAd.keyword_records = (ad.keyword_records || []).filter(record => {
                    if (selectedMarket) {
                        return record.market === selectedMarket;
                    }
                    return true;
                });
                
                // 如果有搜索文本，在已筛选的市场记录中继续筛选
                if (searchText) {
                    newAd.keyword_records = newAd.keyword_records.filter(record => {
                        const keyword = (record.keyword || '').toLowerCase();
                        const title = (record.title || '').toLowerCase();
                        const url = (ad.landing_page || '').toLowerCase();
                        
                        return keyword.includes(searchText) || 
                               title.includes(searchText) || 
                               url.includes(searchText);
                    });
                }
                
                // 如果有关键词记录，找出最新的时间戳
                if (newAd.keyword_records && newAd.keyword_records.length > 0) {
                    newAd.latest_timestamp = Math.max(
                        ...newAd.keyword_records.map(record => 
                            record.timestamp ? new Date(record.timestamp).getTime() : 0
                        )
                    );
                }
                
                return newAd.keyword_records.length > 0 ? newAd : null;
            }).filter(ad => ad !== null);
            
            // 按最新时间戳排序
            filteredResults.sort((a, b) => {
                return (b.latest_timestamp || 0) - (a.latest_timestamp || 0);
            });
            
            // 只在非保持市场状态时更新市场标签
            if (!keepMarket) {
                updateMarketTabs(allResults);
            }
            
            displayResults(filteredResults);
        }

        // 更新市场标签函数
        function updateMarketTabs(results) {
            const marketTabs = document.getElementById('marketTabs');
            const activeMarket = document.querySelector('.market-tab.active')?.dataset.market;
            
            // 获取所有出现的市场
            const markets = new Set();
            results.forEach(ad => {
                if (ad.keyword_records) {
                    ad.keyword_records.forEach(record => {
                        if (record.market) markets.add(record.market);
                    });
                }
            });
            
            // 转换为数组并排序
            const marketArray = Array.from(markets).sort();
            
            // 保留"全部"标签
            marketTabs.innerHTML = '<div class="market-tab" data-market="">全部</div>';
            
            // 显示所有市场
            marketArray.forEach(market => {
                const tab = document.createElement('div');
                tab.className = 'market-tab';
                tab.dataset.market = market;
                tab.textContent = countryNames[market] || market.toUpperCase();
                if (market === activeMarket) {
                    tab.classList.add('active');
                }
                marketTabs.appendChild(tab);
            });
            
            // 重新绑定点击事件
            document.querySelectorAll('.market-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.market-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    if (tab.dataset.market === '') {
                        tab.classList.remove('active');
                    }
                    filterAndDisplayResults();
                });
            });
        }

        // 添加关键词搜索事件监听
        const keywordFilter = document.getElementById('keywordFilter');
        const clearSearchBtn = document.getElementById('clearSearch');
        
        keywordFilter.addEventListener('input', function() {
            clearSearchBtn.style.display = this.value ? 'inline-flex' : 'none';
            debounce(filterAndDisplayResults, 300)();
        });

        clearSearchBtn.addEventListener('click', function() {
            keywordFilter.value = '';
            this.style.display = 'none';
            filterAndDisplayResults();
        });

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function displayResults(results) {
            const container = document.getElementById('latestResults');
            container.innerHTML = '';
            
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">没有找到匹配的结果</div></div>';
                return;
            }
            
            // 找出最新的时间戳
            let latestTimestamp = null;
            results.forEach(ad => {
                if (ad.keyword_records) {
                    ad.keyword_records.forEach(record => {
                        // 使用 Date.parse 解析 ISO 格式的时间戳
                        const recordTime = Date.parse(record.timestamp);
                        if (!latestTimestamp || recordTime > latestTimestamp) {
                            latestTimestamp = recordTime;
                        }
                    });
                }
            });
            
            // 获取当前选中的市场
            const selectedMarket = document.querySelector('.market-tab.active')?.dataset.market;
            
            results.forEach(ad => {
                // 数据验证
                if (!ad || typeof ad !== 'object') return;
                
                // 确保keyword_records存在且是数组
                if (!Array.isArray(ad.keyword_records)) return;
                
                // 如果有选中的市场，只显示该市场的记录
                if (selectedMarket) {
                    ad = {
                        ...ad,
                        keyword_records: ad.keyword_records.filter(record => record.market === selectedMarket)
                    };
                    // 如果过滤后没有记录，跳过这个广告
                    if (ad.keyword_records.length === 0) return;
                }
                
                const adCard = createAdCard(ad);
                container.appendChild(adCard);
            });
            
            document.getElementById('totalAds').textContent = results.length;
            
            if (latestTimestamp) {
                document.getElementById('lastUpdated').textContent = new Date(latestTimestamp).toLocaleString();
            } else {
                document.getElementById('lastUpdated').textContent = '未知';
            }
        }

        function openImagePreview(imgSrc) {
            console.log('Opening preview for:', imgSrc);
            const modal = document.getElementById('imagePreviewModal');
            const previewImage = document.getElementById('previewImage');
            
            // 获取所有缩略图
            const allThumbnails = Array.from(document.querySelectorAll('.screenshot-thumbnail'));
            currentPreviewIndex = allThumbnails.findIndex(img => img.src === imgSrc);
            console.log('Current index:', currentPreviewIndex);
            
            previewImage.src = imgSrc;
            modal.style.display = 'block';
            
            // 确保事件监听器只添加一次
            if (!modal.hasClickHandler) {
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        closePreview();
                    }
                };
                modal.hasClickHandler = true;
            }
            
            // 添加键盘事件监听
            document.removeEventListener('keydown', handleKeyPress); // 先移除以前的
            document.addEventListener('keydown', handleKeyPress);
        }
        
        function handleKeyPress(e) {
            const modal = document.getElementById('imagePreviewModal');
            if (modal.style.display !== 'block') return;
            
            const allThumbnails = Array.from(document.querySelectorAll('.screenshot-thumbnail'));
            if (allThumbnails.length === 0) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    currentPreviewIndex = (currentPreviewIndex - 1 + allThumbnails.length) % allThumbnails.length;
                    document.getElementById('previewImage').src = allThumbnails[currentPreviewIndex].src;
                    break;
                case 'ArrowRight':
                    currentPreviewIndex = (currentPreviewIndex + 1) % allThumbnails.length;
                    document.getElementById('previewImage').src = allThumbnails[currentPreviewIndex].src;
                    break;
                case 'Escape':
                    closePreview();
                    break;
            }
        }
        
        function closePreview() {
            const modal = document.getElementById('imagePreviewModal');
            modal.style.display = 'none';
            document.removeEventListener('keydown', handleKeyPress);
        }

        function createAdCard(ad) {
            const card = document.createElement('div');
            card.className = 'col-md-6 col-lg-4 mb-3';
            card.setAttribute('data-url', ad.final_url);
            
            const markets = new Set(ad.keyword_records.map(record => record.market));
            const marketBadges = Array.from(markets)
                .map(market => `<span class="badge bg-${getMarketColor(market)} me-1">${countryNames[market] || market.toUpperCase()}</span>`)
                .join('');

            // 修改关键词记录的 HTML 生成
            const keywordRecordsHtml = ad.keyword_records.map(record => `
                <div class="border-top pt-2 mt-2 position-relative">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-${getMarketColor(record.market)} keyword-badge" 
                              data-keyword="${record.keyword}" 
                              data-market="${record.market}">${record.keyword || ''}</span>
                        <small class="text-muted">${new Date(record.timestamp || Date.now()).toLocaleString()}</small>
                    </div>
                    <div class="small mt-1 text-dark">${record.title || ''}</div>
                </div>
            `).join('');

            card.innerHTML = `
                <div class="card h-100">
                    <div class="menu-dots" onclick="toggleMenu(event, this)">
                        <div class="menu-dropdown">
                            <div class="menu-item delete" onclick="deleteRecord(event, '${ad.final_url}')">
                                删除广告卡片
                            </div>
                            <div class="menu-item refresh" onclick="generateThumbnail('${ad.final_url}', this.closest('.card'))">
                                刷新缩略图
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 position-relative">
                                <img src="/screenshots/${ad.screenshot_path || 'default.png'}" 
                                     alt="Landing Page Screenshot" 
                                     class="img-thumbnail screenshot-thumbnail" 
                                     style="max-width: 100%; max-height: 100%; object-fit: cover;" 
                                     onerror="handleImageError(this, '${ad.screenshot_path}')"
                                     onclick="openImagePreview(this.src)"
                                >
                                <div class="text-center mt-2">
                                    <button class="btn btn-light" onclick="generateThumbnail('${ad.final_url}', this.closest('.card'))" style="border: none; background: none; display: block; opacity: 0.5;">
                                        <i class="fa fa-refresh fa-1x"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">
                                        <a href="${ad.final_url}" target="_blank" class="text-decoration-none">
                                            ${ad.final_url ? new URL(ad.final_url).hostname : '未知域名'}
                                        </a>
                                    </h5>
                                    <div class="market-badges">
                                        ${marketBadges}
                                    </div>
                                </div>
                                <div class="card-text" style="max-height: 450px; overflow-y: auto;">
                                    <p class="text-muted small"><a href="${ad.final_url}" target="_blank">${ad.final_url}</a></p>
                                    ${keywordRecordsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 为卡片中的关键词标签添加点击事件
            card.querySelectorAll('.keyword-badge').forEach(badge => {
                badge.style.cursor = 'pointer';
                badge.addEventListener('click', function() {
                    const keyword = this.getAttribute('data-keyword');
                    searchKeyword(keyword);
                });
            });

            return card;
        }

        // 获取市场对应的颜色
        function getMarketColor(market) {
            const colors = {
                'in': 'primary',
                'gh': 'success',
                'ng': 'info',
                'ke': 'warning',
                'za': 'secondary'
            };
            return colors[market] || 'secondary';
        }

        async function deleteRecord(event, final_url) {
            event.stopPropagation();
            console.log('Attempting to delete record with final_url:', final_url);
            
            try {
                const response = await fetch('/delete_record', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ final_url: final_url })
                });
                
                const data = await response.json();
                console.log('Delete response:', data);
                
                if (data.status === 'success') {
                    allResults = allResults.filter(ad => ad.final_url !== final_url);
                    filterAndDisplayResults();
                    showToast('广告卡片已删除', 'success');
                } else {
                    showToast('删除失败：' + (data.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('删除失败，请重试', 'error');
            }
            closeAllMenus();
        }

        // 关闭所有打开的菜单
        function closeAllMenus() {
            document.querySelectorAll('.menu-dropdown.show').forEach(menu => {
                menu.classList.remove('show');
            });
        }

        // 切换菜单显示状态
        function toggleMenu(event, element) {
            event.stopPropagation();
            const dropdown = element.querySelector('.menu-dropdown');
            
            // 先关闭其他所有菜单
            closeAllMenus();
            
            // 切换当前菜单
            dropdown.classList.toggle('show');
        }

        // 点击页面其他地方时关闭菜单
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.menu-dots')) {
                closeAllMenus();
            }
        });

        // 加载初始结果
        fetch('/latest')
            .then(response => response.json())
            .then(results => {
                allResults = results;
                displayResults(results);
            })
            .catch(error => {
                console.error('Error:', error);
                // 显示错误信息
            });

        // 更新错误信息显示
        function showPreviewError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
                <div class="mb-3">${message}</div>
                <button class="btn btn-sm btn-outline-primary" onclick="window.open('${currentPreviewUrl}', '_blank')">
                    在新窗口打开
                </button>
            `;
        }

        // 全部按钮点击事件
        document.querySelector('.market-tab[data-market=""]').addEventListener('click', function() {
            // 清空关键词搜索输入框
            document.getElementById('keywordFilter').value = '';
            
            // 触发输入事件以更新过滤
            const event = new Event('input', { bubbles: true });
            document.getElementById('keywordFilter').dispatchEvent(event);
        });

        // 添加搜索关键词的函数
        function searchKeyword(keyword) {
            const keywordFilter = document.getElementById('keywordFilter');
            const clearSearchBtn = document.getElementById('clearSearch');
            keywordFilter.value = keyword;
            clearSearchBtn.style.display = 'inline-flex';
            filterAndDisplayResults();
        }


        // 处理图片加载错误
        function handleImageError(img, originalPath) {
            if (!originalPath) {
                img.style.display = 'none';
                return;
            }
            
            // 尝试不同的图片格式
            const formats = ['.jpg', '.png'];
            const currentFormat = originalPath.toLowerCase().slice(-4);
            const basePath = originalPath.slice(0, -4);
            
            // 找到当前格式的索引
            const currentIndex = formats.indexOf(currentFormat);
            if (currentIndex === -1 || currentIndex === formats.length - 1) {
                // 如果当前格式未知或是最后一个格式，隐藏图片
                img.style.display = 'none';
                return;
            }
            
            // 尝试下一个格式
            const nextFormat = formats[(currentIndex + 1) % formats.length];
            const newPath = basePath + nextFormat;
            
            // 更新图片源
            img.src = `/screenshots/${newPath}`;
        }
        
        // 添加图片预览模态框点击关闭事件
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('imagePreviewModal');
            const modalContent = modal.querySelector('.image-preview-content');
            
            // 阻止图片点击事件冒泡
            modalContent.onclick = function(e) {
                e.stopPropagation();
            };
        });

        // 生成缩略图
        function generateThumbnail(url, cardElement) {
            const button = cardElement.querySelector('button');
            if (!button) {
                console.error('Button element not found');
                return;
            }
            
            // 禁用按钮并显示加载状态
            button.disabled = true;
            button.innerHTML = '<i class="fa fa-spinner fa-spin fa-1x"></i>';
            
            fetch('/generate-thumbnail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // 更新当前卡片的图片
                    const imgElement = document.createElement('img');
                    imgElement.src = `/screenshots/${data.screenshot_path}?t=${new Date().getTime()}`; // 添加时间戳避免缓存
                    imgElement.alt = 'Landing Page Screenshot';
                    imgElement.className = 'img-thumbnail screenshot-thumbnail';
                    imgElement.style = 'max-width: 100%; max-height: 100%; object-fit: cover; cursor: pointer;';
                    imgElement.onclick = function() {
                        openImagePreview(this.src);
                    };
                    
                    // 找到并替换原有图片
                    const oldImg = cardElement.querySelector('.screenshot-thumbnail');
                    if (oldImg) {
                        oldImg.parentNode.replaceChild(imgElement, oldImg);
                    }
                    
                    // 更新全局结果中的截图路径
                    const finalUrl = url;
                    const resultIndex = allResults.findIndex(r => r.final_url === finalUrl);
                    if (resultIndex !== -1) {
                        allResults[resultIndex].screenshot_path = data.screenshot_path;
                    }
                    
                    showToast('缩略图已更新', 'success');
                } else {
                    throw new Error(data.error || '生成缩略图失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast(error.message, 'error');
            })
            .finally(() => {
                // 恢复按钮状态
                button.disabled = false;
                button.innerHTML = '<i class="fa fa-refresh fa-1x"></i>';
            });
        }

        // 初始化分类选择框
        const categorySelect = document.getElementById('categorySelect');
        if (categorySelect) {
            categorySelect.addEventListener('change', function() {
                StateModule.setSelectedCategory(this.value);
                filterAndDisplayResults(true);
            });
        }

        // 更新分类选择框选项
        function updateCategorySelect() {
            const categorySelect = document.getElementById('categorySelect');
            if (!categorySelect) return;

            const categories = Object.keys(keywordManager.keywordsData);
            let html = '<option value="">所有分类</option>';
            
            categories.forEach(category => {
                html += `<option value="${category}">${category}</option>`;
            });
            
            categorySelect.innerHTML = html;
        }

        // 在加载关键词数据后更新分类选择框
        keywordManager.loadKeywords().then(() => {
            updateCategorySelect();
        });
    </script>
</body>
</html>
